name: Kasm Install with Vortex

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Change directory to /tmp
    - name: Change directory to /tmp
      run: cd /tmp

    # Download and install Vortex
    - name: Download and install Vortex
      run: |
        curl -O https://www.vtxhub.com/download/1.1.7/linux/vortex.zip
        sudo apt-get install unzip -y
        sudo unzip vortex.zip -d /tmp/vortex

    # Check current directory and list contents
    - name: Check current directory and list contents
      run: |
        pwd
        ls -l

    # Run Vortex with save option
    - name: Run Vortex with save option
      run: /tmp/vortex/vortex --save

    # Create a script to automatically input details to Vortex
    - name: Create input script
      run: |
        cat << 'EOF' > input.sh
        #!/usr/bin/expect -f
        set timeout -1
        spawn /tmp/vortex/vortex
        match_max 100000
        expect -exact "email: "
        send -- "peyisa6677@hisotyr.com\r"
        expect -exact "password: "
        send -- "peyisa6677@hisotyr.com\r"
        expect -exact "Pin: "
        send -- "1234\r"
        expect -exact "Site Selection: "
        send -- "1\r"
        expect -exact "IP and Port Selection: "
        send -- "1\r"
        expect -exact "IP: "
        send -- "\r"
        expect -exact "Port: "
        send -- "433\r"
        expect eof
        EOF

    # Make the input script executable
    - name: Make input script executable
      run: chmod +x input.sh

    # Run the input script to enter details into Vortex
    - name: Run input script
      run: ./input.sh

    # Download Kasm release archive
    - name: Download Kasm release archive
      run: |
        cd /tmp
        curl -O https://kasm-static-content.s3.amazonaws.com/kasm_release_1.15.0.06fdc8.tar.gz

    # Extract Kasm release archive
    - name: Extract Kasm release archive
      run: |
        cd /tmp
        tar -xf kasm_release_1.15.0.06fdc8.tar.gz

    # Run Kasm installation script with 'yes' response
    - name: Run Kasm installation script with 'yes' response
      run: |
        yes | sudo bash /tmp/kasm_release/install.sh

    # Manually edit xstartup
    - name: Manually edit xstartup
      run: |
        # Instructions to manually edit the xstartup file
        # You may need to open the file in a text editor and make the necessary changes

    # Troubleshoot select-de.sh
    - name: Troubleshoot select-de.sh
      run: |
        # Investigate why select-de.sh is failing to execute
        # Check for any errors in the script or missing dependencies

    # Start Vortex tunnel at port 443
    - name: Start Vortex tunnel at port 443
      run: /tmp/vortex/vortex http 443 &

    # Display IP address
    - name: Display IP address
      run: ip addr show

    # Delay for 1 hour
    - name: Delay for 1 hour
      run: sleep 3600
